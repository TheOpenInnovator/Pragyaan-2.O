<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPSC Master - Advanced Quiz Platform</title>
    <!-- Add after line 7 (after title tag) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
       * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    }

    :root {
        --primary: #2563eb;
        --primary-light: #3b82f6;
        --secondary: #059669;
        --accent: #dc2626;
        --warning: #f59e0b;
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-tertiary: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
        --border: #475569;
        --success: #10b981;
        --error: #ef4444;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --radius-sm: 6px;
        --radius-md: 8px;
        --radius-lg: 12px;
    }

    body {
        background: linear-gradient(135deg, var(--bg-primary) 0%, #1a202c 100%);
        color: var(--text-primary);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        min-height: 100vh;
        line-height: 1.6;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
    }

    @media (min-width: 768px) {
        .container {
            padding: 1.5rem;
        }
    }

    .header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-md);
    }

    .header h1 {
        background: linear-gradient(135deg, var(--primary-light), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: clamp(1.75rem, 4vw, 2.5rem);
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .header p {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    @media (min-width: 768px) {
        .header p {
            font-size: 1rem;
        }
    }

    .tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        background: var(--bg-secondary);
        padding: 0.75rem;
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .tabs::-webkit-scrollbar {
        display: none;
    }

    .tab {
        padding: 0.75rem 1rem;
        background: transparent;
        color: var(--text-secondary);
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.875rem;
        font-weight: 500;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .tab:hover {
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary-light);
    }

    .tab.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .card {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        border: 1px solid var(--border);
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-sm);
    }

    .input-group {
        margin-bottom: 1.25rem;
    }

    .input-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.875rem;
    }

    .input-field {
        width: 100%;
        padding: 0.75rem;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 0.875rem;
        transition: border-color 0.2s ease;
    }

    .input-field:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .textarea-field {
        min-height: 12rem;
        resize: vertical;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.8rem;
    }

    .btn {
        padding: 0.75rem 1.25rem;
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        text-decoration: none;
        justify-content: center;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-light);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-success {
        background: var(--success);
        color: white;
    }

    .btn-success:hover {
        background: #059669;
    }

    .btn-warning {
        background: var(--warning);
        color: white;
    }

    .btn-warning:hover {
        background: #d97706;
    }

    .btn-error {
        background: var(--error);
        color: white;
    }

    .btn-error:hover {
        background: #dc2626;
    }

    .btn-secondary {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border: 1px solid var(--border);
    }

    .btn-secondary:hover {
        background: var(--border);
        color: var(--text-primary);
    }

    .quiz-layout {
        display: grid;
        gap: 1.5rem;
        min-height: calc(100vh - 15rem);
    }

    @media (min-width: 1024px) {
        .quiz-layout {
            grid-template-columns: 280px 1fr;
        }
    }

    .question-navigator {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        border: 1px solid var(--border);
        height: fit-content;
        position: sticky;
        top: 1rem;
    }

    @media (max-width: 1023px) {
        .question-navigator {
            position: static;
            max-height: 50vh;
            overflow-y: auto;
        }
    }

    .nav-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(2.5rem, 1fr));
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .nav-btn {
        aspect-ratio: 1;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        transition: all 0.2s ease;
        min-height: 2.5rem;
    }

    .nav-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
    }

    .nav-btn.answered {
        background: var(--success);
        color: white;
        border-color: var(--success);
    }

    .nav-btn.marked {
        background: var(--warning);
        color: white;
        border-color: var(--warning);
    }

    .nav-btn.current {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        transform: scale(1.05);
    }

    .nav-btn.incorrect {
        background: var(--error);
        color: white;
        border-color: var(--error);
    }

    .question-area {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .question-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        background: rgba(37, 99, 235, 0.05);
    }

    .question-content {
        padding: 1.5rem;
        flex: 1;
        overflow-y: auto;
        max-height: 60vh;
    }

    @media (min-width: 1024px) {
        .question-content {
            max-height: 70vh;
        }
    }

    .question-stem {
        font-size: 1rem;
        line-height: 1.7;
        margin-bottom: 1.5rem;
        white-space: pre-line;
        color: var(--text-primary);
    }

    .options {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .option {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 1rem;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .option:hover {
        border-color: var(--primary);
        background: rgba(37, 99, 235, 0.05);
    }

    .option.selected {
        border-color: var(--primary);
        background: rgba(37, 99, 235, 0.1);
    }

    .option.correct {
        border-color: var(--success);
        background: rgba(16, 185, 129, 0.1);
    }

    .option.incorrect {
        border-color: var(--error);
        background: rgba(239, 68, 68, 0.1);
    }

    .option input[type="radio"] {
        margin-top: 0.125rem;
        accent-color: var(--primary);
    }

    .option label {
        flex: 1;
        cursor: pointer;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .question-footer {
        padding: 1.5rem;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        background: rgba(37, 99, 235, 0.05);
    }

    .timer {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--warning);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-variant-numeric: tabular-nums;
    }

    .timer.critical {
        color: var(--error);
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--bg-secondary);
        padding: 1.5rem;
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        text-align: center;
        box-shadow: var(--shadow-sm);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        font-variant-numeric: tabular-nums;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 500;
    }

    .question-review {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
    }

    .question-review.correct {
        border-left: 4px solid var(--success);
    }

    .question-review.incorrect {
        border-left: 4px solid var(--error);
    }

    .question-review.skipped {
        border-left: 4px solid var(--warning);
    }

    .rationale {
        background: var(--bg-primary);
        padding: 1rem;
        border-radius: var(--radius-md);
        margin-top: 1rem;
        border-left: 3px solid var(--primary);
        font-size: 0.875rem;
        line-height: 1.6;
    }

    .progress-bar {
        width: 100%;
        height: 0.5rem;
        background: var(--bg-primary);
        border-radius: var(--radius-sm);
        overflow: hidden;
        margin-bottom: 0.75rem;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        transition: width 0.3s ease;
    }

    .search-filter {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }

    .search-input {
        flex: 1;
        min-width: 200px;
    }

    .filter-select {
        padding: 0.75rem;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 0.875rem;
        min-width: 140px;
    }

    .alert {
        padding: 1rem;
        border-radius: var(--radius-md);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.875rem;
    }

    .alert-success {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid var(--success);
        color: var(--success);
    }

    .alert-error {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid var(--error);
        color: var(--error);
    }

    .alert-warning {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid var(--warning);
        color: var(--warning);
    }

    .hidden {
        display: none !important;
    }

    .loading {
        display: inline-block;
        width: 1.25rem;
        height: 1.25rem;
        border: 2px solid var(--border);
        border-radius: 50%;
        border-top-color: var(--primary);
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .schema-template {
        background: var(--bg-primary);
        padding: 1rem;
        border-radius: var(--radius-md);
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.75rem;
        overflow-x: auto;
        white-space: pre;
        line-height: 1.4;
        border: 1px solid var(--border);
    }

    .quiz-controls {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 1rem;
    }

    .mains-question-container {
        background: var(--bg-primary);
        padding: 1.5rem;
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
    }

    /* Responsive Typography */
    @media (max-width: 768px) {
        .question-stem {
            font-size: 0.9rem;
        }
        
        .option label {
            font-size: 0.8rem;
        }
        
        .btn {
            padding: 0.625rem 1rem;
            font-size: 0.8rem;
        }
        
        .card {
            padding: 1rem;
        }
        
        .question-header,
        .question-footer {
            padding: 1rem;
        }
        
        .question-content {
            padding: 1rem;
            max-height: 50vh;
        }
    }

    /* Dark mode optimizations */
    @media (prefers-color-scheme: dark) {
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
        }
    }

    /* High contrast mode */
    @media (prefers-contrast: high) {
        :root {
            --border: #64748b;
            --text-secondary: #e2e8f0;
        }
    }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏛️ Pragyaan 2.O</h1>
            <p>Advanced Quiz Platform for Prelims & Mains Preparation</p>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="upload">📤 Dataset Upload</button>
            <button class="tab" data-tab="quiz">📝 Quiz Practice</button>
            <button class="tab" data-tab="results">📊 Results & Analytics</button>
            <button class="tab" data-tab="schema">⚙️ Schema Helper</button>
        </div>

        <!-- Upload Tab -->
        <div class="tab-content active" id="upload">
            <div class="card">
                <h3>Import Quiz Dataset</h3>
                <div class="input-group">
                    <label>Upload JSON File</label>
                    <input type="file" class="input-field" id="fileInput" accept=".json">
                </div>
                <div class="input-group">
                    <label>Or Paste JSON Data</label>
                    <textarea class="input-field textarea-field" id="jsonInput" placeholder="Paste your JSON dataset here..."></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" id="validateData">🔍 Validate & Load</button>
                    <button class="btn btn-secondary" id="clearData">🗑️ Clear</button>
                </div>
                <div id="validationMessage"></div>
            </div>
        </div>

        <!-- Quiz Tab -->
        <div class="tab-content" id="quiz">
            <div id="quizNotLoaded" class="card">
                <h3>No Quiz Loaded</h3>
                <p>Please upload a valid JSON dataset first to start practicing.</p>
            </div>
            
            <div id="quizInterface" class="hidden">
                <div class="card">
                    <div class="search-filter">
                        <input type="text" class="input-field search-input" id="questionSearch" placeholder="🔍 Search questions...">
                        <select class="filter-select" id="statusFilter">
                            <option value="all">All Questions</option>
                            <option value="answered">Answered</option>
                            <option value="unanswered">Unanswered</option>
                            <option value="marked">Marked for Review</option>
                        </select>
                        <select class="filter-select" id="difficultyFilter">
                            <option value="all">All Difficulty</option>
                            <option value="Easy">Easy</option>
                            <option value="Moderate">Moderate</option>
                            <option value="Hard">Hard</option>
                        </select>
                    </div>
                    <div class="quiz-controls">
                        <button class="btn btn-success" id="startQuiz">🚀 Start Quiz</button>
                        <button class="btn btn-warning" id="pauseQuiz" style="display:none;">⏸️ Pause</button>
                        <button class="btn btn-primary" id="resumeQuiz" style="display:none;">▶️ Resume</button>
                        <button class="btn btn-error" id="submitQuiz" style="display:none;">📤 Submit Quiz</button>
                    </div>
                </div>

                <div id="quizStarted" class="hidden">
                    <div class="quiz-layout">
                        <div class="question-navigator">
                            <div class="timer" id="timer">⏰ 00:00:00</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <p><strong>Question Navigator</strong></p>
                            <div class="nav-grid" id="navGrid"></div>
                            <div style="margin-top: 15px; font-size: 12px;">
                                <div style="color: var(--success);">● Answered</div>
                                <div style="color: var(--warning);">● Marked</div>
                                <div style="color: var(--text-secondary);">● Not Attempted</div>
                            </div>
                        </div>

                        <div class="question-area">
                            <div class="question-header">
                                <div>
                                    <span id="questionCounter">Question 1 of 10</span>
                                    <span id="questionTags"></span>
                                </div>
                                <div id="timerDisplay" class="timer">⏰ 00:00:00</div>
                            </div>
                            
                            <div class="question-content">
                                <div class="question-stem" id="questionStem"></div>
                                <div class="options" id="optionsContainer"></div>
                            </div>
                            
                            <div class="question-footer">
                                <div>
                                    <button class="btn btn-secondary" id="prevQuestion">← Previous</button>
                                    <button class="btn btn-secondary" id="nextQuestion">Next →</button>
                                </div>
                                <div>
                                    <button class="btn btn-warning" id="markReview">⭐ Mark for Review</button>
                                    <button class="btn btn-primary" id="clearResponse">🗑️ Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Tab -->
        <div class="tab-content" id="results">
            <div id="resultsNotAvailable" class="card">
                <h3>No Results Available</h3>
                <p>Complete a quiz to view detailed results and analytics.</p>
            </div>

            <div id="resultsInterface" class="hidden">
               <!-- Replace the stats-grid section (lines 442-464) -->

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="finalScore" style="color: var(--primary);">0</div>
                        <div class="stat-label">Final Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="questionsAttempted" style="color: var(--secondary);">0</div>
                        <div class="stat-label">Questions Attempted</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctAnswers" style="color: var(--success);">0</div>
                        <div class="stat-label">Correct Answers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="incorrectAnswers" style="color: var(--error);">0</div>
                        <div class="stat-label">Incorrect Answers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="accuracy" style="color: var(--warning);">0%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="timeTaken" style="color: var(--text-secondary);">0m</div>
                        <div class="stat-label">Time Taken</div>
                    </div>
                </div>

                <div class="card">
                    <h3>Performance Analysis</h3>
                    <div id="performanceChart"></div>
                    <button class="btn btn-primary" id="exportResults">📊 Export Results</button>
                    <button class="summary-download" id="downloadSummary">📁 Download Summary PDF</button>
                </div>

                <div class="results-section">
                    <h3>Question Review</h3>
                    <div id="questionReviews"></div>
                </div>
            </div>
        </div>

        <!-- Schema Tab -->
        <div class="tab-content" id="schema">
            <div class="card">
                <h3>Enhanced JSON Schema Template</h3>
                <p>Use this enhanced schema for creating comprehensive quiz datasets:</p>
                <div class="schema-template" id="schemaTemplate"></div>
                <button class="btn btn-primary" id="downloadSchema">💾 Download Schema Template</button>
            </div>
        </div>
    </div>

    <script>
                  class UPSCQuizPlatform {
                    constructor() {
                        this.currentDataset = null;
                        this.currentQuestionIndex = 0;
                        this.userAnswers = {};
                        this.markedQuestions = new Set();
                        this.quizStartTime = null;
                        this.timer = null;
                        this.quizResults = null;
                        this.isQuizActive = false;
                        this.elapsedTime = 0;
                        
                        this.initializeEventListeners();
                        this.loadFromStorage();
                        this.renderSchemaTemplate();
                    }

                    initializeEventListeners() {
                        // Tab switching
                        document.querySelectorAll('.tab').forEach(tab => {
                            tab.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
                        });

                        // File upload and data handling
                        document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileUpload(e));
                        document.getElementById('validateData').addEventListener('click', () => this.validateAndLoadData());
                        document.getElementById('clearData').addEventListener('click', () => this.clearData());

                        // Quiz controls
                        document.getElementById('startQuiz').addEventListener('click', () => this.startQuiz());
                        document.getElementById('submitQuiz').addEventListener('click', () => this.submitQuiz());

                        // Question navigation
                        document.getElementById('prevQuestion').addEventListener('click', () => this.navigateQuestion(-1));
                        document.getElementById('nextQuestion').addEventListener('click', () => this.navigateQuestion(1));
                        document.getElementById('markReview').addEventListener('click', () => this.toggleMarkReview());
                        document.getElementById('clearResponse').addEventListener('click', () => this.clearResponse());

                        // Export functions
                        document.getElementById('exportResults').addEventListener('click', () => this.exportResults());
                        document.getElementById('downloadSchema').addEventListener('click', () => this.downloadSchemaTemplate());
                        document.getElementById('downloadSummary').addEventListener('click', () => this.downloadSummaryPDF());

                        // Auto-save every 30 seconds
                        setInterval(() => {
                            if (this.isQuizActive && this.currentDataset) {
                                this.saveToStorage();
                            }
                        }, 30000);
                    }

                    switchTab(tabName) {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                        
                        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                        document.getElementById(tabName).classList.add('active');
                    }

                    async handleFileUpload(event) {
                        const file = event.target.files[0];
                        if (file) {
                            try {
                                const text = await file.text();
                                document.getElementById('jsonInput').value = text;
                                this.showMessage(`File "${file.name}" loaded successfully.`, 'success');
                            } catch (error) {
                                this.showMessage('Error reading file: ' + error.message, 'error');
                            }
                        }
                    }

                    validateAndLoadData() {
                        const jsonText = document.getElementById('jsonInput').value.trim();
                        if (!jsonText) {
                            this.showMessage('Please provide JSON data', 'error');
                            return;
                        }

                        try {
                            const data = JSON.parse(jsonText);
                            
                            if (this.validateSchema(data)) {
                                this.currentDataset = this.preprocessDataset(data);
                                this.saveToStorage();
                                this.initializeQuiz();
                                this.showMessage(`Dataset loaded! ${this.currentDataset.questions.length} questions found.`, 'success');
                                this.switchTab('quiz');
                            }
                        } catch (error) {
                            this.showMessage('Invalid JSON: ' + error.message, 'error');
                        }
                    }

                    preprocessDataset(data) {
                        // Add defaults for missing fields
                        data.questions = data.questions.map((question, index) => ({
                            id: question.id || `Q${String(index + 1).padStart(3, '0')}`,
                            question_type: question.question_type || 'MCQ',
                            exam_type: question.exam_type || 'prelims',
                            stem: question.stem || '',
                            options: question.options || [],
                            answer: question.answer || '',
                            rationale: question.rationale || '',
                            difficulty: question.difficulty || 'Moderate',
                            estimated_time: question.estimated_time || 90,
                            ...question
                        }));

                        // Ensure quiz config has defaults
                        data.quiz.config = {
                            marks_per_question: 2,
                            negative_marking: { type: 'fraction', value: 0.33 },
                            time_limit_minutes: 120,
                            ...data.quiz.config
                        };

                        return data;
                    }

                    validateSchema(data) {
                        if (!data.quiz || !data.questions) {
                            this.showMessage('Missing required fields: quiz, questions', 'error');
                            return false;
                        }

                        if (!Array.isArray(data.questions) || data.questions.length === 0) {
                            this.showMessage('Questions array is empty or invalid', 'error');
                            return false;
                        }

                        // Basic question validation
                        for (let i = 0; i < data.questions.length; i++) {
                            const question = data.questions[i];
                            if (!question.stem) {
                                this.showMessage(`Question ${i + 1}: Missing question stem`, 'error');
                                return false;
                            }
                        }

                        return true;
                    }

                    initializeQuiz() {
                        document.getElementById('quizNotLoaded').classList.add('hidden');
                        document.getElementById('quizInterface').classList.remove('hidden');
                        this.generateNavigationGrid();
                    }

                    generateNavigationGrid() {
                        const navGrid = document.getElementById('navGrid');
                        navGrid.innerHTML = '';
                        
                        this.currentDataset.questions.forEach((question, index) => {
                            const btn = document.createElement('button');
                            btn.className = 'nav-btn';
                            btn.textContent = index + 1;
                            btn.addEventListener('click', () => this.jumpToQuestion(index));
                            navGrid.appendChild(btn);
                        });
                    }

                    startQuiz() {
                        this.isQuizActive = true;
                        this.quizStartTime = Date.now();
                        this.elapsedTime = 0;
                        this.startTimer();
                        
                        document.getElementById('startQuiz').style.display = 'none';
                        document.getElementById('submitQuiz').style.display = 'inline-flex';
                        document.getElementById('quizStarted').classList.remove('hidden');
                        
                        this.displayQuestion(0);
                        this.showMessage('Quiz started!', 'success');
                    }

                    startTimer() {
                        const timeLimit = this.currentDataset.quiz.config.time_limit_minutes * 60;
                        
                        this.timer = setInterval(() => {
                            this.elapsedTime++;
                            const remaining = timeLimit - this.elapsedTime;
                            
                            if (remaining <= 0) {
                                this.submitQuiz(true);
                                return;
                            }
                            
                            this.updateTimerDisplay(remaining);
                        }, 1000);
                    }

                    updateTimerDisplay(seconds) {
                        const hours = Math.floor(seconds / 3600);
                        const minutes = Math.floor((seconds % 3600) / 60);
                        const secs = seconds % 60;
                        const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                        
                        document.getElementById('timer').innerHTML = `⏰ ${timeString}`;
                        document.getElementById('timerDisplay').innerHTML = `⏰ ${timeString}`;
                    }

                    displayQuestion(index) {
                        if (index < 0 || index >= this.currentDataset.questions.length) return;
                        
                        this.currentQuestionIndex = index;
                        const question = this.currentDataset.questions[index];
                        
                        // Update question counter
                        document.getElementById('questionCounter').textContent = 
                            `Question ${index + 1} of ${this.currentDataset.questions.length}`;
                        
                        // Display question stem
                        document.getElementById('questionStem').textContent = question.stem;
                        
                        // Display options
                        if (question.exam_type === 'mains') {
                            this.displayMainsQuestion(question);
                        } else {
                            this.displayMCQQuestion(question);
                        }
                        
                        this.updateMarkReviewButton(question);
                        this.updateNavigationButtons();
                        this.updateNavigationGrid();
                    }

                    displayMCQQuestion(question) {
                        const optionsContainer = document.getElementById('optionsContainer');
                        optionsContainer.innerHTML = '';
                        
                        question.options.forEach(option => {
                            const optionDiv = document.createElement('div');
                            optionDiv.className = 'option';
                            optionDiv.innerHTML = `
                                <input type="radio" name="question_${question.id}" value="${option.id}" id="option_${option.id}_${question.id}">
                                <label for="option_${option.id}_${question.id}" style="flex: 1; cursor: pointer;">${option.id}) ${option.text}</label>
                            `;
                            
                            optionDiv.addEventListener('click', () => {
                                const radio = optionDiv.querySelector('input[type="radio"]');
                                radio.checked = true;
                                this.selectOption(question.id, option.id);
                            });
                            
                            optionsContainer.appendChild(optionDiv);
                        });
                        
                        // Restore previous answer if exists
                        if (this.userAnswers[question.id]) {
                            const selectedOption = document.querySelector(`input[name="question_${question.id}"][value="${this.userAnswers[question.id]}"]`);
                            if (selectedOption) {
                                selectedOption.checked = true;
                                selectedOption.closest('.option').classList.add('selected');
                            }
                        }
                    }

                    displayMainsQuestion(question) {
                        const optionsContainer = document.getElementById('optionsContainer');
                        const wordLimit = question.mains_details?.word_limit || 150;
                        
                        optionsContainer.innerHTML = `
                            <div class="mains-question-container" style="background: var(--bg-dark); padding: 20px; border-radius: 8px;">
                                <div style="margin-bottom: 15px;">
                                    <strong>Word Limit:</strong> ${wordLimit} words
                                </div>
                                <textarea 
                                    class="input-field" 
                                    id="mainsAnswer_${question.id}" 
                                    placeholder="Write your answer here..."
                                    style="min-height: 200px; width: 100%;"
                                ></textarea>
                                <div style="margin-top: 10px; font-size: 12px;">
                                    Word count: <span id="wordCount_${question.id}">0</span> / ${wordLimit}
                                </div>
                            </div>
                        `;
                        
                        const textarea = document.getElementById(`mainsAnswer_${question.id}`);
                        const wordCountSpan = document.getElementById(`wordCount_${question.id}`);
                        
                        textarea.addEventListener('input', () => {
                            const text = textarea.value.trim();
                            const wordCount = text === '' ? 0 : text.split(/\s+/).length;
                            wordCountSpan.textContent = wordCount;
                            this.userAnswers[question.id] = textarea.value;
                            this.updateNavigationGrid();
                        });
                        
                        // Restore previous answer
                        if (this.userAnswers[question.id]) {
                            textarea.value = this.userAnswers[question.id];
                            const wordCount = textarea.value.trim().split(/\s+/).length;
                            wordCountSpan.textContent = wordCount;
                        }
                    }

                    selectOption(questionId, optionId) {
                        this.userAnswers[questionId] = optionId;
                        
                        // Update visual selection
                        document.querySelectorAll(`input[name="question_${questionId}"]`).forEach(radio => {
                            radio.closest('.option').classList.remove('selected');
                        });
                        
                        const selectedOption = document.querySelector(`input[name="question_${questionId}"][value="${optionId}"]`);
                        if (selectedOption) {
                            selectedOption.closest('.option').classList.add('selected');
                        }
                        
                        this.updateNavigationGrid();
                    }

                    navigateQuestion(direction) {
                        const newIndex = this.currentQuestionIndex + direction;
                        if (newIndex >= 0 && newIndex < this.currentDataset.questions.length) {
                            this.displayQuestion(newIndex);
                        }
                    }

                    jumpToQuestion(index) {
                        if (index >= 0 && index < this.currentDataset.questions.length) {
                            this.displayQuestion(index);
                        }
                    }

                    updateMarkReviewButton(question) {
                        const markBtn = document.getElementById('markReview');
                        if (this.markedQuestions.has(question.id)) {
                            markBtn.innerHTML = '⭐ Unmark Review';
                        } else {
                            markBtn.innerHTML = '⭐ Mark for Review';
                        }
                    }

                    toggleMarkReview() {
                        const currentQuestion = this.currentDataset.questions[this.currentQuestionIndex];
                        
                        if (this.markedQuestions.has(currentQuestion.id)) {
                            this.markedQuestions.delete(currentQuestion.id);
                        } else {
                            this.markedQuestions.add(currentQuestion.id);
                        }
                        
                        this.updateMarkReviewButton(currentQuestion);
                        this.updateNavigationGrid();
                    }

                    clearResponse() {
                        const currentQuestion = this.currentDataset.questions[this.currentQuestionIndex];
                        delete this.userAnswers[currentQuestion.id];
                        
                        if (currentQuestion.exam_type === 'mains') {
                            const textarea = document.getElementById(`mainsAnswer_${currentQuestion.id}`);
                            const wordCountSpan = document.getElementById(`wordCount_${currentQuestion.id}`);
                            if (textarea) textarea.value = '';
                            if (wordCountSpan) wordCountSpan.textContent = '0';
                        } else {
                            document.querySelectorAll(`input[name="question_${currentQuestion.id}"]`).forEach(radio => {
                                radio.checked = false;
                                radio.closest('.option').classList.remove('selected');
                            });
                        }
                        
                        this.updateNavigationGrid();
                    }

                    updateNavigationButtons() {
                        document.getElementById('prevQuestion').disabled = this.currentQuestionIndex === 0;
                        document.getElementById('nextQuestion').disabled = this.currentQuestionIndex === this.currentDataset.questions.length - 1;
                    }

                    updateNavigationGrid() {
                        const navButtons = document.querySelectorAll('.nav-btn');
                        navButtons.forEach((btn, index) => {
                            btn.classList.remove('answered', 'marked', 'current');
                            
                            if (index === this.currentQuestionIndex) {
                                btn.classList.add('current');
                            } else if (this.userAnswers[this.currentDataset.questions[index].id]) {
                                btn.classList.add('answered');
                            }
                            
                            if (this.markedQuestions.has(this.currentDataset.questions[index].id)) {
                                btn.classList.add('marked');
                            }
                        });
                    }

                    submitQuiz(autoSubmit = false) {
                        const unansweredCount = this.currentDataset.questions.length - Object.keys(this.userAnswers).length;
                        
                        if (!autoSubmit && unansweredCount > 0) {
                            if (!confirm(`You have ${unansweredCount} unanswered questions. Submit anyway?`)) return;
                        }
                        
                        if (!autoSubmit && !confirm('Submit quiz? You cannot change answers after submission.')) return;
                        
                        clearInterval(this.timer);
                        this.isQuizActive = false;
                        
                        this.calculateResults();
                        this.displayResults();
                        this.switchTab('results');
                        
                        this.showMessage(autoSubmit ? 'Quiz auto-submitted!' : 'Quiz submitted!', 'success');
                    }

                    calculateResults() {
                        const config = this.currentDataset.quiz.config;
                        const marksPerQuestion = config.marks_per_question || 2;
                        const negativeMarking = config.negative_marking || { type: 'fraction', value: 0.33 };
                        
                        let correct = 0;
                        let incorrect = 0;
                        let skipped = 0;
                        let totalScore = 0;
                        
                        const questionResults = [];
                        
                        this.currentDataset.questions.forEach(question => {
                            const userAnswer = this.userAnswers[question.id];
                            const isCorrect = question.exam_type === 'mains' || userAnswer === question.answer;
                            
                            let questionScore = 0;
                            let status = 'skipped';
                            
                            if (userAnswer) {
                                if (question.exam_type === 'mains') {
                                    questionScore = marksPerQuestion;
                                    correct++;
                                    status = 'attempted';
                                } else if (isCorrect) {
                                    questionScore = marksPerQuestion;
                                    correct++;
                                    status = 'correct';
                                } else {
                                    questionScore = -marksPerQuestion * negativeMarking.value;
                                    incorrect++;
                                    status = 'incorrect';
                                }
                            } else {
                                skipped++;
                            }
                            
                            totalScore += questionScore;
                            
                            questionResults.push({
                                question,
                                userAnswer,
                                isCorrect,
                                status,
                                score: questionScore
                            });
                        });
                        
                        const maxScore = this.currentDataset.questions.length * marksPerQuestion;
                        const accuracy = this.currentDataset.questions.length > 0 ? (correct / this.currentDataset.questions.length) * 100 : 0;
                        
                        this.quizResults = {
                            totalScore,
                            maxScore,
                            correct,
                            incorrect,
                            skipped,
                            accuracy,
                            timeTaken: Date.now() - this.quizStartTime,
                            questionResults
                        };
                    }

                    displayResults() {
                        document.getElementById('resultsNotAvailable').classList.add('hidden');
                        document.getElementById('resultsInterface').classList.remove('hidden');
                        
                        const results = this.quizResults;
                        const attempted = results.correct + results.incorrect;
                        
                        // Update stats
                        document.getElementById('finalScore').textContent = `${results.totalScore.toFixed(2)}/${results.maxScore}`;
                        document.getElementById('questionsAttempted').textContent = `${attempted}/${this.currentDataset.questions.length}`;
                        document.getElementById('correctAnswers').textContent = results.correct;
                        document.getElementById('incorrectAnswers').textContent = results.incorrect;
                        document.getElementById('accuracy').textContent = `${results.accuracy.toFixed(1)}%`;
                        document.getElementById('timeTaken').textContent = this.formatTime(results.timeTaken);
                        
                        this.displayQuestionReviews();
                    }

                    displayQuestionReviews() {
                        const container = document.getElementById('questionReviews');
                        container.innerHTML = '';
                        
                        this.quizResults.questionResults.forEach((result, index) => {
                            const reviewDiv = document.createElement('div');
                            reviewDiv.className = `question-review ${result.status}`;
                            
                            const statusIcon = {
                                correct: '✅',
                                incorrect: '❌',
                                skipped: '⏭️',
                                attempted: '📝'
                            };
                            
                            reviewDiv.innerHTML = `
                                <h4>${statusIcon[result.status]} Question ${index + 1}</h4>
                                <div style="margin-bottom: 15px;">${result.question.stem}</div>
                                
                                ${result.question.exam_type !== 'mains' && result.question.options ? `
                                    <div style="margin-bottom: 15px;">
                                        ${result.question.options.map(option => {
                                            let style = 'padding: 8px; border-radius: 4px; margin: 4px 0;';
                                            if (option.id === result.question.answer) {
                                                style += ' background: rgba(16, 185, 129, 0.2); border: 1px solid var(--success);';
                                            }
                                            if (option.id === result.userAnswer && result.userAnswer !== result.question.answer) {
                                                style += ' background: rgba(239, 68, 68, 0.2); border: 1px solid var(--error);';
                                            }
                                            return `<div style="${style}">${option.id}) ${option.text}</div>`;
                                        }).join('')}
                                    </div>
                                ` : ''}
                                
                                <div><strong>Your Answer:</strong> ${result.userAnswer || 'Not answered'}</div>
                                ${result.question.exam_type !== 'mains' ? `<div><strong>Correct Answer:</strong> ${result.question.answer}</div>` : ''}
                                
                                ${result.question.rationale ? `
                                    <div class="rationale">
                                        <strong>Explanation:</strong><br>
                                        ${result.question.rationale}
                                    </div>
                                ` : ''}
                                
                                <div style="margin-top: 10px; font-weight: bold; color: ${result.score >= 0 ? 'var(--success)' : 'var(--error)'};">
                                    Score: ${result.score >= 0 ? '+' : ''}${result.score.toFixed(2)} marks
                                </div>
                            `;
                            
                            container.appendChild(reviewDiv);
                        });
                    }

                    downloadSummaryPDF() {
                        if (!this.quizResults) {
                            this.showMessage('No results available.', 'error');
                            return;
                        }

                        if (typeof window.jspdf === 'undefined') {
                            this.showMessage('PDF library not loaded.', 'error');
                            return;
                        }

                        try {
                            const { jsPDF } = window.jspdf;
                            const doc = new jsPDF();
                            let yPos = 20;

                            // Header
                            doc.setFontSize(20);
                            doc.text('UPSC Quiz Summary', 20, yPos);
                            yPos += 20;

                            // Results
                            doc.setFontSize(12);
                            doc.text(`Score: ${this.quizResults.totalScore.toFixed(2)}/${this.quizResults.maxScore}`, 20, yPos);
                            yPos += 10;
                            doc.text(`Accuracy: ${this.quizResults.accuracy.toFixed(1)}%`, 20, yPos);
                            yPos += 10;
                            doc.text(`Time: ${this.formatTime(this.quizResults.timeTaken)}`, 20, yPos);
                            yPos += 20;

                            // Question details
                            this.quizResults.questionResults.forEach((result, index) => {
                                if (yPos > 250) {
                                    doc.addPage();
                                    yPos = 20;
                                }
                                
                                doc.text(`Q${index + 1}: ${result.status.toUpperCase()}`, 20, yPos);
                                yPos += 10;
                                doc.text(result.question.stem.substring(0, 80) + '...', 20, yPos);
                                yPos += 10;
                                doc.text(`Score: ${result.score.toFixed(2)}`, 20, yPos);
                                yPos += 15;
                            });

                            doc.save(`quiz_summary_${Date.now()}.pdf`);
                            this.showMessage('PDF downloaded!', 'success');
                        } catch (error) {
                            this.showMessage('PDF generation failed: ' + error.message, 'error');
                        }
                    }

                    exportResults() {
                        if (!this.quizResults) {
                            this.showMessage('No results to export.', 'error');
                            return;
                        }
                        
                        const exportData = {
                            quiz: this.currentDataset.quiz,
                            results: this.quizResults,
                            userAnswers: this.userAnswers,
                            exportDate: new Date().toISOString()
                        };
                        
                        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `quiz_results_${Date.now()}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        this.showMessage('Results exported!', 'success');
                    }

                    renderSchemaTemplate() {
                        const schema = {
                            "quiz": {
                                "title": "Sample Quiz",
                                "config": {
                                    "marks_per_question": 2,
                                    "negative_marking": { "type": "fraction", "value": 0.33 },
                                    "time_limit_minutes": 120
                                }
                            },
                            "questions": [
                                {
                                    "id": "Q001",
                                    "exam_type": "prelims",
                                    "stem": "Sample question?",
                                    "options": [
                                        { "id": "A", "text": "Option A" },
                                        { "id": "B", "text": "Option B" },
                                        { "id": "C", "text": "Option C" },
                                        { "id": "D", "text": "Option D" }
                                    ],
                                    "answer": "A",
                                    "rationale": "Explanation here"
                                }
                            ]
                        };
                        
                        document.getElementById('schemaTemplate').textContent = JSON.stringify(schema, null, 2);
                    }

                    downloadSchemaTemplate() {
                        const schemaText = document.getElementById('schemaTemplate').textContent;
                        const blob = new Blob([schemaText], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `quiz_schema_template.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        this.showMessage('Schema downloaded!', 'success');
                    }

                    formatTime(milliseconds) {
                        const totalSeconds = Math.floor(milliseconds / 1000);
                        const hours = Math.floor(totalSeconds / 3600);
                        const minutes = Math.floor((totalSeconds % 3600) / 60);
                        const seconds = totalSeconds % 60;
                        
                        if (hours > 0) {
                            return `${hours}h ${minutes}m`;
                        } else {
                            return `${minutes}m ${seconds}s`;
                        }
                    }

                    saveToStorage() {
                        try {
                            const data = {
                                dataset: this.currentDataset,
                                answers: this.userAnswers,
                                markedQuestions: Array.from(this.markedQuestions),
                                currentIndex: this.currentQuestionIndex,
                                results: this.quizResults,
                                isQuizActive: this.isQuizActive,
                                elapsedTime: this.elapsedTime
                            };
                            
                            localStorage.setItem('upsc_quiz_data', JSON.stringify(data));
                        } catch (error) {
                            console.error('Save failed:', error);
                        }
                    }

                    loadFromStorage() {
                        try {
                            const stored = localStorage.getItem('upsc_quiz_data');
                            if (stored) {
                                const data = JSON.parse(stored);
                                this.currentDataset = data.dataset;
                                this.userAnswers = data.answers || {};
                                this.markedQuestions = new Set(data.markedQuestions || []);
                                this.currentQuestionIndex = data.currentIndex || 0;
                                this.quizResults = data.results;
                                this.isQuizActive = data.isQuizActive || false;
                                this.elapsedTime = data.elapsedTime || 0;
                                
                                if (this.currentDataset) {
                                    this.initializeQuiz();
                                }
                                
                                if (this.quizResults) {
                                    this.displayResults();
                                }
                            }
                        } catch (error) {
                            console.error('Load failed:', error);
                        }
                    }

                    clearData() {
                        if (confirm('Clear all data?')) {
                            localStorage.removeItem('upsc_quiz_data');
                            location.reload();
                        }
                    }

                    showMessage(message, type) {
                        const container = document.getElementById('validationMessage');
                        if (!container) return;
                        
                        const alertDiv = document.createElement('div');
                        alertDiv.className = `alert alert-${type}`;
                        alertDiv.innerHTML = `<span>${message}</span>`;
                        
                        container.innerHTML = '';
                        container.appendChild(alertDiv);
                        
                        if (type === 'success') {
                            setTimeout(() => container.innerHTML = '', 3000);
                        }
                    }
                }

                // Initialize when DOM is loaded
                document.addEventListener('DOMContentLoaded', () => {
                    try {
                        const app = new UPSCQuizPlatform();
                        window.upscQuizApp = app;
                    } catch (error) {
                        console.error('Initialization failed:', error);
                    }
                });
    </script>
</body>
</html>
